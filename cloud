#!/usr/bin/env python
#
# cloud - an easy to use tool for spawning disposable VM on an Openstack
#         cloud
#
# Francois Deppierraz <francois.deppierraz@nimag.net>
#
# License GPLv2+ applies

import os
import sys
import time
import subprocess
import pickle
import tempfile
import logging
import argparse
import ipaddr

IMAGE     = 'trusty-server-cloudimg-amd64'
FLAVOR    = 'm1.small'
KEY_NAME  = os.environ['USER']
NAME      = 'cloud-script-disposable-vm'

KNOWN_HOSTS = tempfile.NamedTemporaryFile()
CLEANUPS = []

def setup_environment():
  if not 'OS_PASSWORD' in os.environ:
    source = '. ~/.openrc'
    dump = '/usr/bin/python -c "import os,pickle;print pickle.dumps(os.environ)"'
    penv = os.popen('%s && %s' %(source,dump))
    env = pickle.loads(penv.read())
    os.environ = env
  
  if not 'OS_PASSWORD' in os.environ:
    raise Exception('No Openstack environnment variables found!')


def ssh(args):
  logging.debug("ssh " + repr(args))
  return subprocess.call(['ssh', '-q', '-o', 'StrictHostKeyChecking=no', '-o', 'UserKnownHostsFile=%s' % KNOWN_HOSTS.name] + args)

def scp(args):
  logging.debug("scp" + repr(args))
  return subprocess.call(['scp', '-q', '-o', 'StrictHostKeyChecking=no', '-o', 'UserKnownHostsFile=%s' % KNOWN_HOSTS.name] + args)

def get_global_ip(nt, instance):
  logging.debug("Instance addresses: %s", instance.addresses)
  for net in instance.addresses:
    for address in instance.addresses[net]:
      ip = address['addr']
      if not ipaddr.IPv4Address(ip).is_private:
        logging.debug("Found global IP address: %s", ip)
        return ip

  ip = nt.floating_ips.create()
  CLEANUPS.append(ip)
  logging.debug("Floating IP %s" % ip.ip)
  instance.add_floating_ip(ip)
  return ip.ip

def main(args):
  logging.debug("Connecting to Openstack cloud at %s" % (os.environ['OS_AUTH_URL']))
  
  try:
    from novaclient.v1_1 import client
    nt = client.Client(os.environ['OS_USERNAME'], os.environ['OS_PASSWORD'], os.environ['OS_TENANT_NAME'], os.environ['OS_AUTH_URL'], service_type="compute")
  
    try:
      image = filter(lambda im: args.image.lower() in im.name.lower(), nt.images.list())[0]
    except IndexError:
      logging.error("Image %s not found!" % args.image.lower())
      sys.exit(1)
    
    flavor = nt.flavors.find(name=args.flavor)
  
    if args.net:
      nics = [{'net-id': nt.networks.find(label=args.net).id}]
    else:
      nics = None

    if args.volume:
      logging.debug("Boot from volume based on image %s of size %d GB", image.id, args.volume_size)
      bdm = [{
        'uuid': image.id,
        'source_type': 'image',
        'destination_type': 'volume',
        'delete_on_termination': True,
        'volume_size': args.volume_size,
        'boot_index': 0
      }]
      image = None
    else:
      bdm = None
      image = image.id

    instance = nt.servers.create(
      name=args.name,
      image=image,
      flavor=flavor.id,
      key_name=args.key_name,
      nics=nics,
      block_device_mapping_v2 = bdm
    )
    CLEANUPS.append(instance)

    logging.debug("Instance %s" % instance.id)
  
    while True:
      instance = nt.servers.get(instance.id)
      logging.debug(instance.status)
      if instance.status == 'ERROR':
        raise Exception('Instance creation failure')
      if instance.addresses != {}:
        logging.debug("IP addresses present")
        break
      else:
        time.sleep(1)

    ssh_ip = get_global_ip(nt, instance)
    logging.debug("Globally reachable IP: %s", ssh_ip)

    instance.add_security_group(args.secgroup)
  
    while True:
      res = ssh(['%s@%s' % (args.user, ssh_ip), 'echo'])
      if res == 0:
        break
      else:
        time.sleep(5)

    if args.script:
      logging.debug("Executing user supplied script: %s", args.script)
      scp([os.path.abspath(args.script), '%s@%s:/tmp/script' % (args.user, ssh_ip)])
      if args.root:
        ssh(['-t', '%s@%s' % (args.user, ssh_ip), 'chmod +x /tmp/script && sudo /tmp/script'])
      else:
        ssh(['-t', '%s@%s' % (args.user, ssh_ip), 'chmod +x /tmp/script && /tmp/script'])
    elif args.command:
      logging.debug("Executing user supplied command: %s", args.command)
      ssh(['-t', '%s@%s' % (args.user, ssh_ip), args.command])
    else:
      logging.debug("Executing interactive shell")
      ssh(['-t', '%s@%s' % (args.user, ssh_ip)])

  finally:
    if not args.permanent:
      logging.debug("Cleanup...")

      for cleanup in CLEANUPS:
        cleanup.delete()
        logging.debug("%s deleted", cleanup)

def usage():
  print("Usage: %s [script]" % sys.argv[0])

if __name__ == '__main__':
  global DEBUG

  parser = argparse.ArgumentParser(description='Easy to use tool for spawning disposable VM on an Openstack')
  parser.add_argument('--debug', '-d', action='store_true')
  parser.add_argument('--image', '-i', default=IMAGE)
  parser.add_argument('--flavor', '-f', default=FLAVOR)
  parser.add_argument('--name', '-n', default=NAME)
  parser.add_argument('--net', default='default')
  parser.add_argument('--permanent', '-p', action='store_true')
  parser.add_argument('--root', '-r', action='store_true')
  parser.add_argument('--command', '-c')
  parser.add_argument('--key-name', '-k', default=KEY_NAME)
  parser.add_argument('--volume', '-v', action='store_true')
  parser.add_argument('--volume-size', '-s', type=int, default=10)
  parser.add_argument('--user', '-u', default='ubuntu')
  parser.add_argument('--secgroup', default='all')
  parser.add_argument('script', nargs='?', default=False, help='Script that will automatically be run inside the VM')
  args = parser.parse_args()

  if args.debug:
    logger = logging.getLogger()
    logger.setLevel(logging.DEBUG)

  try:
    setup_environment()
    main(args)
  finally:
    KNOWN_HOSTS.close()
